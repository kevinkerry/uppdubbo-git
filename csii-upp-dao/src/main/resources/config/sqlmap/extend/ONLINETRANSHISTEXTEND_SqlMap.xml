<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ONLINETRANSHISTEXTEND">
   <!-- 确认支付更新总交易历史流水表 -->
	<update id="updateOnlineTransHist"  parameterClass="java.util.HashMap">
	UPDATE
	   ONLINETRANSHIST
	SET
	   CONFIRMEDAMT=ifnull(CONFIRMEDAMT,0)+#TransAmt#,CONFIRMEDCOUNT=ifnull(CONFIRMEDCOUNT,0)+1,DATELASTMAINT = CSII_CURRENTDATETIME()
	WHERE
	   TRANSSEQNBR=#TransSeqNbr# AND
	   TRANSSTATUS NOT IN ('1','9')
	</update>	
	<insert id="insertOnlinetranshistToAll"  parameterClass="java.util.HashMap">
	<![CDATA[
		insert into ONLINETRANSHISTALL (TRANSSEQNBR, TRANSDATE, MERSEQNBR, DOWNSYSTRANSNBR, CHANNELNBR,
		CLEARDATE, DOWNSYSDATE, MERTRANSDATE, MERTRANSDATETIME, TRANSTYPCD,
		TRANSCODE, MERNBR, MEROPENDEPTNBR, MERDEVDEPTNBR, CUSTCIFNBR,
		PAYERCARDTYPCD, PAYEECARDTYPCD, PAYERACCTNBR, PAYERACCTTYPCD,
		PAYERACCTKIND, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTKIND, PAYEEACCTTYPCD, PAYEEACCTNAME,
		TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, TRANSAMT3, TRANSAMT4,
		FEEAMT, DOWNSYSRESPCODE, RESPCODE, TRANSSTATUS, PROCSTEP, PROCSTATUS,
		MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, DOWNSYSDATETIME, SYSTEMCODE,
		TRANSMODE, SIGNNBR, PROFITSEQNBR, CONFIRMEDAMT, CONFIRMEDCOUNT,
		REFUNDMODE, INTERALAMT, INTERALFLAG, DEDUCTAMT, REALAMT, ORIGMERSEQNBR,
		ORIGMERDATE, ORIGSEQNBR, ORIGCLEARDATE, CHECKSTATUS, PAYTYPCD,
		CYBERTYPCD,DATELASTMAINT)
		select TRANSSEQNBR, TRANSDATE, MERSEQNBR, DOWNSYSTRANSNBR, CHANNELNBR,
		CLEARDATE, DOWNSYSDATE, MERTRANSDATE, MERTRANSDATETIME, TRANSTYPCD,
		TRANSCODE, MERNBR, MEROPENDEPTNBR, MERDEVDEPTNBR, CUSTCIFNBR,
		PAYERCARDTYPCD, PAYEECARDTYPCD, PAYERACCTNBR, PAYERACCTTYPCD,
		PAYERACCTKIND, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTKIND, PAYEEACCTTYPCD, PAYEEACCTNAME,
		TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, TRANSAMT3, TRANSAMT4,
		FEEAMT, DOWNSYSRESPCODE, RESPCODE, TRANSSTATUS, PROCSTEP, PROCSTATUS,
		MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, DOWNSYSDATETIME, SYSTEMCODE,
		TRANSMODE, SIGNNBR, PROFITSEQNBR, CONFIRMEDAMT, CONFIRMEDCOUNT,
		REFUNDMODE, INTERALAMT, INTERALFLAG, DEDUCTAMT, REALAMT, ORIGMERSEQNBR,
		ORIGMERDATE, ORIGSEQNBR, ORIGCLEARDATE, CHECKSTATUS, PAYTYPCD,
		CYBERTYPCD,DATELASTMAINT
		from ONLINETRANSHIST
		where cleardate < #clearDate#
	]]>
	</insert>
</sqlMap>