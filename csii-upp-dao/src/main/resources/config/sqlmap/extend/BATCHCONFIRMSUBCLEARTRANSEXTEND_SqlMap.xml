<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BATCHCONFIRMSUBCLEARTRANSEXTEND">
	<insert id="InsertBatchConfirmSubClearTrans" parameterClass="java.util.HashMap">
		INSERT INTO BatchConfirmSubClearTrans
		(SUBTRANSSEQNBR, TRANSSEQNBR,
		DOWNSYSSEQNBR, CLEARDATE, MERTRANSDATE,
		MERTRANSDATETIME, ORIGSUBMERSEQNBR, ORIGSUBMERTRANSDATE, ORIGSUBTRANSSEQNBR,
		ORIGCLEARDATE, TRANSCODE, MERNBR,
		MEROPENDEPTNBR, MERDEVDEPTNBR, PAYERACCTKIND, PAYEEACCTKIND, PAYERCARDTYPCD,
		PAYEECARDTYPCD, CUSTCIFNBR,
		PAYERACCTNBR, PAYERACCTTYPCD, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTTYPCD,
		PAYEEACCTNAME, TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, TRANSAMT1, TRANSAMT2,
		FEEAMT, TRANSSTATUS,
		PROCSTEP, PROCSTATUS, MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, SYSTEMCODE,
		TRANSMODE, TRANSTYPCD, PROFITSEQNBR,
		CONFIRMEDPAYAMT, CONFIRMEDPAYDATE, CONFIRMEDCLEARDATE, CONFIRMEDMERSEQNBR,
		CONFIRMEDMERDATETIME, REFUNDMODE, MERSEQNBR,
		TRANSDATE, PAYTYPCD, FEENBR, SUPFEENBR, ELECPORTFLAG,DATELASTMAINT)
		SELECT SUBTRANSSEQNBR, TRANSSEQNBR, DOWNSYSSEQNBR, CLEARDATE, MERTRANSDATE,
		MERTRANSDATETIME, ORIGSUBMERSEQNBR, ORIGSUBMERTRANSDATE,
		ORIGSUBTRANSSEQNBR, ORIGCLEARDATE, TRANSCODE, MERNBR,
		MEROPENDEPTNBR, MERDEVDEPTNBR, PAYERACCTKIND, PAYEEACCTKIND, PAYERCARDTYPCD,
		PAYEECARDTYPCD, CUSTCIFNBR,
		PAYERACCTNBR, PAYERACCTTYPCD, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTTYPCD,
		PAYEEACCTNAME, TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, TRANSAMT1, TRANSAMT2,
		FEEAMT, TRANSSTATUS,
		PROCSTEP, PROCSTATUS, MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, SYSTEMCODE,
		TRANSMODE, TRANSTYPCD, PROFITSEQNBR,
		CONFIRMEDPAYAMT, CONFIRMEDPAYDATE, CONFIRMEDCLEARDATE, CONFIRMEDMERSEQNBR,
		CONFIRMEDMERDATETIME, REFUNDMODE, MERSEQNBR,
		TRANSDATE, PAYTYPCD, FEENBR, SUPFEENBR, ELECPORTFLAG,DATELASTMAINT FROM
		(
		SELECT
		SUBTRANSSEQNBR, TRANSSEQNBR, DOWNSYSSEQNBR, CLEARDATE, MERTRANSDATE,
		MERTRANSDATETIME, ORIGSUBMERSEQNBR, ORIGSUBMERTRANSDATE,
		ORIGSUBTRANSSEQNBR, ORIGCLEARDATE, TRANSCODE, MERNBR,
		MEROPENDEPTNBR, MERDEVDEPTNBR, PAYERACCTKIND, PAYEEACCTKIND, PAYERCARDTYPCD,
		PAYEECARDTYPCD, CUSTCIFNBR,
		PAYERACCTNBR, PAYERACCTTYPCD, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTTYPCD,
		<!-- 支付结算金额取transamt2,未退金额2016-11-03 wangtao -->
		PAYEEACCTNAME, TRANSAMT2 TRANSAMT, CURRENCYCD, REFUNDEDAMT,
		UNREFUNDAMT, TRANSAMT1, TRANSAMT2, FEEAMT, TRANSSTATUS,
		PROCSTEP, PROCSTATUS, MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, SYSTEMCODE,
		TRANSMODE, TRANSTYPCD, PROFITSEQNBR,
		CONFIRMEDPAYAMT, CONFIRMEDPAYDATE, CONFIRMEDCLEARDATE, CONFIRMEDMERSEQNBR,
		CONFIRMEDMERDATETIME, REFUNDMODE, MERSEQNBR,
		TRANSDATE, PAYTYPCD, FEENBR, SUPFEENBR, ELECPORTFLAG,DATELASTMAINT FROM
		OnlineSubTransHist
		WHERE ProcStep = '1'
		AND
		ConfirmedClearDate=#ClearDate#
		AND TransStatus in ('0','3','4')
		and
		DEPARTMENTNBR=#departmentnbr#
		UNION ALL
		SELECT SUBTRANSSEQNBR,
		TRANSSEQNBR, DOWNSYSSEQNBR, CLEARDATE, MERTRANSDATE,
		MERTRANSDATETIME, ORIGSUBMERSEQNBR, ORIGSUBMERTRANSDATE, ORIGSUBTRANSSEQNBR,
		ORIGCLEARDATE, TRANSCODE, MERNBR,
		MEROPENDEPTNBR, MERDEVDEPTNBR, PAYERACCTKIND, PAYEEACCTKIND, PAYERCARDTYPCD,
		PAYEECARDTYPCD, CUSTCIFNBR,
		PAYERACCTNBR, PAYERACCTTYPCD, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTTYPCD,
		PAYEEACCTNAME, TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, TRANSAMT1, TRANSAMT2,
		FEEAMT, TRANSSTATUS,
		PROCSTEP, PROCSTATUS, MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, SYSTEMCODE,
		TRANSMODE, TRANSTYPCD, PROFITSEQNBR,
		CONFIRMEDPAYAMT, CONFIRMEDPAYDATE, CONFIRMEDCLEARDATE, CONFIRMEDMERSEQNBR,
		CONFIRMEDMERDATETIME, REFUNDMODE, MERSEQNBR,
		TRANSDATE, PAYTYPCD, FEENBR, SUPFEENBR, ELECPORTFLAG,DATELASTMAINT FROM
		OnlineSubTransHist
		WHERE ProcStep IN ('1','3','5')
		AND RefundMode='2'
		AND TRANSTYPCD='01'
		AND ClearDate=#ClearDate#
		AND TransStatus='0'
		and
		DEPARTMENTNBR=#departmentnbr#
		<!-- 此部分情况不存在，注释2016-11-03 wangtao -->
		<!-- UNION ALL SELECT SUBTRANSSEQNBR, TRANSSEQNBR, DOWNSYSSEQNBR, CLEARDATE, 
			MERTRANSDATE, MERTRANSDATETIME, ORIGSUBMERSEQNBR, ORIGSUBMERTRANSDATE, ORIGSUBTRANSSEQNBR, 
			ORIGCLEARDATE, TRANSCODE, MERNBR, MEROPENDEPTNBR, MERDEVDEPTNBR, PAYERACCTKIND, 
			PAYEEACCTKIND, PAYERCARDTYPCD, PAYEECARDTYPCD, CUSTCIFNBR, PAYERACCTNBR, 
			PAYERACCTTYPCD, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR, PAYEEACCTDEPTNBR, 
			PAYEEACCTTYPCD, PAYEEACCTNAME, TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, 
			TRANSAMT1, TRANSAMT2, FEEAMT, TRANSSTATUS, PROCSTEP, PROCSTATUS, MEMO1, TRANSTIME, 
			MEMO2, DEPARTMENTNBR, SYSTEMCODE, TRANSMODE, TRANSTYPCD, PROFITSEQNBR, CONFIRMEDPAYAMT, 
			CONFIRMEDPAYDATE, CONFIRMEDCLEARDATE, CONFIRMEDMERSEQNBR, CONFIRMEDMERDATETIME, 
			REFUNDMODE, MERSEQNBR, TRANSDATE, PAYTYPCD, FEENBR, SUPFEENBR, ELECPORTFLAG,DATELASTMAINT 
			FROM OnlineSubTransHist WHERE OrigSubTransSeqNbr in (SELECT SubTransSeqNbr 
			FROM OnlineSubTransHist WHERE ConfirmedClearDate = #ClearDate# AND ProcStep 
			= '1') AND ProcStep IN ('1','3','5') AND RefundMode = '1' AND TRANSTYPCD='01' 
			AND TransStatus='0' AND ClearDate=#ClearDate# and DEPARTMENTNBR=#departmentnbr# -->
		UNION ALL
		SELECT SUBTRANSSEQNBR, TRANSSEQNBR, DOWNSYSSEQNBR, CLEARDATE,
		MERTRANSDATE,
		MERTRANSDATETIME, ORIGSUBMERSEQNBR, ORIGSUBMERTRANSDATE, ORIGSUBTRANSSEQNBR,
		ORIGCLEARDATE, TRANSCODE, MERNBR,
		MEROPENDEPTNBR, MERDEVDEPTNBR, PAYERACCTKIND, PAYEEACCTKIND, PAYERCARDTYPCD,
		PAYEECARDTYPCD, CUSTCIFNBR,
		PAYERACCTNBR, PAYERACCTTYPCD, PAYERACCTDEPTNBR, PAYERACCTNAME, PAYEEACCTNBR,
		PAYEEACCTDEPTNBR, PAYEEACCTTYPCD,
		PAYEEACCTNAME, TRANSAMT, CURRENCYCD, REFUNDEDAMT, UNREFUNDAMT, TRANSAMT1, TRANSAMT2,
		FEEAMT, TRANSSTATUS,
		PROCSTEP, PROCSTATUS, MEMO1, TRANSTIME, MEMO2, DEPARTMENTNBR, SYSTEMCODE,
		TRANSMODE, TRANSTYPCD, PROFITSEQNBR,
		CONFIRMEDPAYAMT, CONFIRMEDPAYDATE, CONFIRMEDCLEARDATE, CONFIRMEDMERSEQNBR,
		CONFIRMEDMERDATETIME, REFUNDMODE, MERSEQNBR,
		TRANSDATE, PAYTYPCD, FEENBR, SUPFEENBR, ELECPORTFLAG,DATELASTMAINT FROM
		OnlineSubTransHist
		WHERE ProcStep IN ('1','3','5')
		AND TRANSTYPCD='02'
		AND TransStatus='0'
		AND
		ClearDate=#ClearDate#
		and DEPARTMENTNBR=#departmentnbr#
		) temp
	</insert>

	<select id="queryConfirmTransList" parameterClass="java.util.HashMap"
		resultClass="com.csii.upp.dto.generate.Batchconfirmsubcleartrans">
	<![CDATA[
    SELECT b.* FROM batchconfirmsubcleartrans b, meracctinfo m, meracctinfo s WHERE b.mernbr = m.mernbr AND m.supermernbr = s.mernbr AND b.procstep = '1' AND s.clearclassmodecd = #clearClassModeCd#
     ]]>
	</select>

	<select id="queryOnlineTransList" parameterClass="java.util.HashMap"
		resultClass="com.csii.upp.dto.generate.Onlinetranshist">
	<![CDATA[
    SELECT distinct a.* FROM batchconfirmsubcleartrans b,OnlineTransHist a, meracctinfo m WHERE b.transseqnbr = a.transseqnbr AND a.mernbr = m.mernbr AND b.procstep = '1' AND m.clearclassmodecd = #clearClassModeCd#
     ]]>
	</select>


	<select id="queryAcctInfo" resultClass="java.util.HashMap"
		parameterClass="java.util.HashMap">
	<![CDATA[
	SELECT M.SETTLEACCTNBR, M.SETTLEACCTTYP, M.SETTLEACCTKIND, M.SETTLEACCTNAME, 
        M.FEEACCTNBR, M.FEEACCTNAME, M.FEEACCTKIND, M.FEEACCTTYP,
        M.MEROPENDEPTNBR, M.FEEMODE, M.SETTMODE, M.SETTPERIOD, M.CARDTYPECD
        D.FEEACCTNBR, D.FEEACCTKIND, D.FEEACCTTPYCD, D.FEEACCTNAME,
        D.DEPTNBR, D.ACCTNBR, D.ACCTNAME, D.ACCTKINDCD
	FROM MERACCTINFO M, DEPTACCTINFO D WHERE M.MERDEVELOPDEPTNBR = D.DEPTNBR AND M.MERNBR = #merNbr#
     ]]>
	</select>

	<select id="getBatchconfirmsubcleartrans" resultClass="java.util.HashMap"
		parameterClass="java.util.HashMap">
	<![CDATA[
     select sum(TRANSAMT) TRANSAMT, sum(UNREFUNDAMT) UNREFUNDAMT,SUPFEENBR from BATCHCONFIRMSUBCLEARTRANS where TRANSSEQNBR = #transSeqNbr# group by SUPFEENBR
     ]]>
	</select>
	<select id="getOrigOnlinesubtrans" resultClass="java.util.HashMap"
		parameterClass="java.util.HashMap">
	<![CDATA[
     select a.TRANSAMT, b.UNREFUNDAMT,a.SUPFEENBR from BATCHCONFIRMSUBCLEARTRANS a,ONLINESUBTRANSHIST b where a.ORIGSUBTRANSSEQNBR=b.SUBTRANSSEQNBR and a.TRANSSEQNBR = #transSeqNbr#
     ]]>
	</select>
</sqlMap>